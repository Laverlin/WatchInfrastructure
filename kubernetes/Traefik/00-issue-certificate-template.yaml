# Cron job to issue certificate
#
apiVersion: batch/v1
kind: CronJob
metadata:
  name: acme-ssl
  namespace: ingress
spec:
  schedule: "0 0 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: acme-ssl
              image: neilpang/acme.sh
              args:
                - --set-notify 
                - --notify-hook telegram
                - --issue -d #%DOMAIN_NAME%#
                - --dns dns_namecom 
                - --server letsencrypt.org
                - --key-file /acmeout/#%DOMAIN_NAME%#.key \
                - --fullchain-file /acmeout/#%DOMAIN_NAME%#.full \
              env:
                - name: Namecom_Username
                  valueFrom:
                    secretKeyRef:
                      name: secret-data
                      key: NAMECOM_USER 
                - name: Namecom_Token 
                  valueFrom:
                    secretKeyRef:
                      name: secret-data
                      key: NAMECOM_TOKEN
                - name: TELEGRAM_BOT_APITOKEN
                  valueFrom:
                    secretKeyRef:
                      name: secret-data
                      key: TELEGRAM_YAS_BOT_KEY
                - name: TELEGRAM_BOT_CHATID
                  valueFrom:
                    secretKeyRef:
                      name: secret-data
                      key: TELEGRAM_CHAT_ID

              volumeMounts:
                - mountPath: "/acmeout"
                  name: acme-out
                - mountPath: "/acme.sh"
                  name: acme-root
          volumes:
            - name: acme-out
              hostPath:
                path: /shared-data/persist/ssl
                type: DirectoryOrCreate
            - name: acme-root
              hostPath:
                path: /shared-data/persist/acme.sh
                type: DirectoryOrCreate